generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Player {
  id             String       @id @default(cuid())
  externalId     String       @unique
  friendCode     String?      @unique
  displayName    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  attempts       GameAttempt[]
  suggestions    Suggestion[]
  friendshipsOut Friendship[] @relation("FriendshipsOut")
  friendshipsIn  Friendship[] @relation("FriendshipsIn")
}

model Puzzle {
  id              String       @id
  preview         Json
  solutionLabel   String
  answer          String
  acceptedAnswers String[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  dailyPuzzles    DailyPuzzle[]
}

model DailyPuzzle {
  dateKey   String   @id
  puzzleId  String
  puzzle    Puzzle   @relation(fields: [puzzleId], references: [id], onDelete: Restrict)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([puzzleId])
}

model GameAttempt {
  id          String   @id @default(cuid())
  playerId    String?
  player      Player?  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  anonymousId String?
  puzzleDate  String
  solved      Boolean  @default(false)
  gaveUp      Boolean  @default(false)
  solvedIn    Int?
  shareCode   String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  guesses     Guess[]

  @@unique([playerId, puzzleDate])
  @@unique([anonymousId, puzzleDate])
  @@index([puzzleDate])
  @@index([anonymousId])
}

model Guess {
  id        String      @id @default(cuid())
  attemptId String
  attempt   GameAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  position  Int
  guess     String
  score     Int
  verdict   String
  reason    String
  correct   Boolean
  createdAt DateTime    @default(now())

  @@unique([attemptId, position])
  @@index([attemptId])
}

model Friendship {
  id        String   @id @default(cuid())
  playerId  String
  friendId  String
  createdAt DateTime @default(now())
  player    Player   @relation("FriendshipsOut", fields: [playerId], references: [id], onDelete: Cascade)
  friend    Player   @relation("FriendshipsIn", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([playerId, friendId])
}

model Suggestion {
  id        String   @id @default(cuid())
  playerId  String?
  player    Player?  @relation(fields: [playerId], references: [id], onDelete: SetNull)
  dateKey   String
  puzzleId  String
  text      String
  createdAt DateTime @default(now())

  @@index([playerId])
  @@index([dateKey])
}
